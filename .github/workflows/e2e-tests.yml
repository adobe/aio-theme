name: E2E tests
on:
  push:
    branches:
      - main
    paths:
      - "example/**"
      - "packages/**"
      - ".github/**"
      - "cypress/**"
  pull_request:
    branches:
      - main
    paths:
      - "example/**"
      - "packages/**"
      - ".github/**"
      - "cypress/**"
jobs:
  smoke_tests:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Print node version
        run: node --version

      - name: Install Yarn
        run: sudo npm install -g yarn
      
      - name: Add hosts to /etc/hosts
        run: |
            sudo echo "127.0.0.1 localhost.corp.adobe.com" | sudo tee -a /etc/hosts

      - name: 'Create env file'
        run: |
          touch ./example/.env
          echo GATSBY_IMS_SRC="https://auth-stg1.services.adobe.com/imslib/imslib.min.js" >> ./example/.env
          echo GATSBY_IMS_CONFIG='{"client_id": "stage_adobe_io", "scope": "AdobeID,openid,unified_dev_portal,read_organizations,additional_info.projectedProductContext,additional_info.roles,gnav,read_pc.dma_bullseye,creative_sdk,adobeio_api,service_principals.read,service_principals.write,read_client_secret", "environment": "stg1"}' >> ./example/.env
          cat ./example/.env

      - name: Run Tests
        uses: cypress-io/github-action@v6
        with:
          install-command: sudo yarn install
          build: sudo yarn build
          start: sudo yarn dev:https
          wait-on: 'https://localhost.corp.adobe.com:9000'
          browser: chrome
          config-file: cypress.config.js
          spec: |
            cypress/e2e/smoke.cy.js
            cypress/e2e/get-credentials.cy.js
        env:
          NODE_TLS_REJECT_UNAUTHORIZED: '0'
